<?php

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\mantle2\Service\ArticlesHelper;
use Drupal\mantle2\Service\CampaignHelper;
use Drupal\mantle2\Service\PromptsHelper;

function mantle2_help($route_name, RouteMatchInterface $route_match)
{
	switch ($route_name) {
		case 'help.page.mantle2':
			$output = '';
			$output .= '<h3>' . Drupal::translation()->translate('About') . '</h3>';
			$output .=
				'<p>' .
				Drupal::translation()->translate('The Drupal backend for The Earth App') .
				'</p>';
			return $output;

		default:
	}
}

function mantle2_mail($key, &$message, $params)
{
	$message['from'] = Drupal::config('system.site')->get('mail');

	/** @var \Drupal\mantle2\Service\HTMLFactory $parser */
	$parser = Drupal::service('mantle2.parser');

	/** @var \Drupal\user\UserInterface $user */
	$user = $params['user'] ?? null;
	if (!$user) {
		Drupal::logger('mantle2')->error('No user object provided for email key: %key', [
			'%key' => $key,
		]);
		return;
	}
	$username = $user->getAccountName();

	// email campaigns that may include unsubscribe links
	if (str_starts_with($key, 'campaign:')) {
		$key = substr($key, 9);
		$campaign = CampaignHelper::getCampaign($key);

		if ($campaign) {
			$message['subject'] = $campaign['title'];
			$markdown = CampaignHelper::runPlaceholders($campaign['body'], $user);

			$message['body'][] = $parser->toHtml(
				$markdown,
				true,
				$params['unsubscribe_url'] ?? null,
			);

			return;
		}
	}

	// determine if this email should include unsubscribe
	$includeUnsubscribe = in_array($key, ['new_login', 'new_password'], true);
	$unsubscribeUrl = $params['unsubscribe_url'] ?? null; // Frontend URL for body link

	switch ($key) {
		case 'email_verification':
			$message['subject'] = 'The Earth App - Email Verification Code';

			$markdown = "Your email verification code is: **{$params['verification_code']}**\n\n
			This code will expire in 15 minutes.\n
			If you did not request this verification, please ignore this email.";

			$message['body'][] = $parser->toHtml($markdown, false);
			break;
		case 'new_login':
			$message['subject'] = 'The Earth App - New Login Notification';
			$markdown = "@$username, Your account was just used to log in from a new device or location.\n\n
			**Details:**\n
			- Time: {$params['time']}\n
			- IP: {$params['ip']} ({$params['additional_ips']})\n
			- User Agent: {$params['user_agent']}\n
			- Referrer: {$params['referer']}\n\n
			If this was you, you can safely ignore this email.\n
			If you did not log in, please reset your password immediately to secure your account.";

			$message['body'][] = $parser->toHtml($markdown, $includeUnsubscribe, $unsubscribeUrl);
			break;
		case 'email_change_notification':
			$message['subject'] = 'The Earth App - Email Change Notification';

			$markdown = "@$username, Your email address was just requested to be changed.\n\n
			Old Email: **{$params['old_email']}**\n\n
			New Email: **{$params['new_email']}**\n\n
			If you did not perform this action, please contact support immediately to secure your account.";

			$message['body'][] = $parser->toHtml($markdown, false);
			break;
		case 'email_change_verification':
			$message['subject'] = 'The Earth App - Email Change Verification Code';

			$markdown = "Your email change verification code is: **{$params['verification_code']}**\n\n
			This code will expire in 15 minutes.\n
			If you did not request this verification, please ignore this email.";

			$message['body'][] = $parser->toHtml($markdown, false);
			break;
		case 'email_change_confirmed':
			$message['subject'] = 'The Earth App - Email Change Confirmation';

			$markdown = "@$username, Your email address has been successfully changed.\n\n
			Old Email: **{$params['old_email']}**\n\n
			New Email: **{$params['new_email']}**\n\n
			If you did not perform this action, please contact support immediately to secure your account.";

			$message['body'][] = $parser->toHtml($markdown, false);
			break;
		case 'password_reset':
			$message['subject'] = 'The Earth App - Password Reset';

			$markdown = "@$username, We received a request to reset your password for The Earth App.\n\n
			Click the link below to reset your password:\n
			{$params['reset_link']}\n\n
			This link will expire in 1 hour.\n\n
			If you did not request this password reset, please ignore this email and your password will remain unchanged.";

			$message['body'][] = $parser->toHtml($markdown, false);
			break;
		case 'new_password':
			$message['subject'] = 'The Earth App - Password Reset';

			$markdown = "@$username, Your password has been successfully changed.\n\n
				If you did not perform this action, please reset your password immediately to secure your account.";

			$message['body'][] = $parser->toHtml($markdown, $includeUnsubscribe, $unsubscribeUrl);
			break;
	}
}

function mantle2_mail_alter(&$message)
{
	$messages = [
		'mantle2_email_verification',
		'mantle2_new_login',
		'mantle2_new_password',
		'mantle2_password_reset',
		'mantle2_email_change_notification',
		'mantle2_email_change_verification',
		'mantle2_email_change_confirmed',
	];

	if (
		in_array($message['id'], $messages, true) ||
		str_starts_with($message['id'], 'mantle2_campaign:')
	) {
		$message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
		$message['params']['convert'] = false;
	}

	// Add List-Unsubscribe headers for campaign emails
	if (str_starts_with($message['id'], 'mantle2_campaign:')) {
		if (isset($message['params']['unsubscribe_api_url'])) {
			$message['headers']['List-Unsubscribe'] =
				'<' . $message['params']['unsubscribe_api_url'] . '>';
			$message['headers']['List-Unsubscribe-Post'] = 'List-Unsubscribe=One-Click';
		}
	}

	// Add List-Unsubscribe headers for specific email types
	$unsubscribableMessages = ['mantle2_new_login', 'mantle2_new_password'];
	if (in_array($message['id'], $unsubscribableMessages, true)) {
		if (isset($message['params']['unsubscribe_api_url'])) {
			$message['headers']['List-Unsubscribe'] =
				'<' . $message['params']['unsubscribe_api_url'] . '>';
			$message['headers']['List-Unsubscribe-Post'] = 'List-Unsubscribe=One-Click';
		}
	}
}

function mantle2_cron()
{
	// Delete expired prompts and articles
	PromptsHelper::checkExpiredPrompts();
	ArticlesHelper::checkExpiredArticles();
	Drupal::logger('mantle2')->notice('[cron] mantle2 cron executed.');

	// Run Email Campaigns
	CampaignHelper::runEmailCampaigns();
}
