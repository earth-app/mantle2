<?php

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\mantle2\Service\ArticlesHelper;
use Drupal\mantle2\Service\PromptsHelper;

function mantle2_help($route_name, RouteMatchInterface $route_match)
{
	switch ($route_name) {
		case 'help.page.mantle2':
			$output = '';
			$output .= '<h3>' . Drupal::translation()->translate('About') . '</h3>';
			$output .=
				'<p>' .
				Drupal::translation()->translate('The Drupal backend for The Earth App') .
				'</p>';
			return $output;

		default:
	}
}

function mantle2_mail($key, &$message, $params)
{
	$message['from'] = Drupal::config('system.site')->get('mail');

	switch ($key) {
		case 'email_verification':
			$message['subject'] = 'The Earth App - Email Verification Code';

			$markdown = <<<EOT
			Your email verification code is: **{$params['verification_code']}**

			This code will expire in 15 minutes.

			If you did not request this verification, please ignore this email.
			EOT;

			$message['body'][] = Drupal::service('mantle2.parser')->toHtml($markdown);
			break;
		case 'new_login':
			$message['subject'] = 'The Earth App - New Login Notification';

			$markdown = <<<EOT
			Your account was just used to log in from a new device or location.

			**Details:**
			- Time: {$params['time']}
			- IP: {$params['ip']} ({$params['additional_ips']})
			- User Agent: {$params['user_agent']}
			- Referrer: {$params['referer']}

			If this was you, you can safely ignore this email.

			If you did not log in, please reset your password immediately to secure your account.
			EOT;

			$message['body'][] = Drupal::service('mantle2.parser')->toHtml($markdown);
			break;
	}
}

function mantle2_mail_alter(&$message)
{
	$messages = ['mantle2_email_verification', 'mantle2_new_login'];
	if (in_array($message['id'], $messages, true)) {
		$message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
		$message['body'] = implode("\n\n", $message['body']);
	}
}

function mantle2_cron()
{
	// Delete expired prompts and articles
	PromptsHelper::checkExpiredPrompts();
	ArticlesHelper::checkExpiredArticles();
	Drupal::logger('mantle2')->notice('[cron] mantle2 cron executed.');
}
