<?php

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\mantle2\Service\ArticlesHelper;
use Drupal\mantle2\Service\PromptsHelper;

function mantle2_help($route_name, RouteMatchInterface $route_match)
{
	switch ($route_name) {
		case 'help.page.mantle2':
			$output = '';
			$output .= '<h3>' . \Drupal::translation()->translate('About') . '</h3>';
			$output .=
				'<p>' .
				\Drupal::translation()->translate('The Drupal backend for The Earth App') .
				'</p>';
			return $output;

		default:
	}
}

function mantle2_mail($key, &$message, $params)
{
	switch ($key) {
		case 'email_verification':
			$message['from'] = Drupal::config('system.site')->get('mail');
			$message['subject'] = Drupal::translation()->translate(
				'The Earth App - Email Verification Code',
			);
			$message['body'][] = Drupal::translation()->translate(
				'Your email verification code is: @code',
				[
					'@code' => $params['verification_code'],
				],
			);
			$message['body'][] = Drupal::translation()->translate(
				'This code will expire in 15 minutes.',
			);
			$message['body'][] = Drupal::translation()->translate(
				'If you did not request this verification, please ignore this email.',
			);
			break;
		case 'new_login':
			$message['from'] = Drupal::config('system.site')->get('mail');
			$message['subject'] = Drupal::translation()->translate(
				'The Earth App - New Login Notification',
			);
			$message['body'][] = Drupal::translation()->translate(
				'Your account was just used to log in from a new device or location.',
			);
			$message['body'][] = Drupal::translation()->translate(
				'Details:\n' . '@time\n' . '@ip (@additional_ips)\n' . '@user_agent\n' . '@referer',
				[
					'@time' => $params['time'],
					'@ip' => $params['ip'],
					'@additional_ips' => $params['additional_ips'],
					'@user_agent' => $params['user_agent'],
					'@referer' => $params['referer'],
				],
			);
			$message['body'][] = Drupal::translation()->translate(
				'If this was you, you can safely ignore this email.',
			);
			$message['body'][] = Drupal::translation()->translate(
				'If you did not log in, please reset your password immediately to secure your account.',
			);
			break;
	}
}

function mantle2_cron()
{
	// Delete expired prompts and articles
	PromptsHelper::checkExpiredPrompts();
	ArticlesHelper::checkExpiredArticles();
	Drupal::logger('mantle2')->notice('[cron] mantle2 cron executed.');
}
